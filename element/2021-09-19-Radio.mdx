---
slug: Radio
title: Radio
authors: [lsh]
tags: [element,radio]
---

## radio核心功能实现

export const Image = ({path}) => {
    return (
        <img style={{boxShadow: "2px 2px 30px #c7ccd7",margin:"20px 0"}} src={path}></img>
    )
}

<Image path="https://img-blog.csdnimg.cn/6b8ac10d639549d893b159fcde921849.png"/>


最简单的用法就是使用`v-model`属性和`label`属性：

```html
<el-radio v-model="radio" label="1">备选项</el-radio>
```

Vue框架的做法是将v-model的值绑定为input的value属性的值，[具体查看](https://cn.vuejs.org/v2/guide/forms.html#%E5%8D%95%E9%80%89%E6%8C%89%E9%92%AE)

:::tip
在Vue2中，当v-model用于自定义组件时候，默认会利用名为 value 的 prop 和名为 input 的事件：

```diff
-<my-component v-model="data"></my-component>

+<my-component :value="data" @input="data = $event"></my-component>
```
:::

因为组件是在原生**input[radio]**的基础上封装了一层，所以必须通过`$emit`向上转发一次事件：

```html title="radio部分源码"
<template>
    <input
        type="radio"
        :value="label"
        v-model="model"
    >
</template>

<script>
    export default {
        props:['label'],
        computed:{
            model: {
                get() {
                    return this.value;
                },
                set(val) {
                    //用户改变了单选时，触发input事件
                    //同时发出的值，正好的label的值
                    this.$emit('input', val);  
                }
            },
        }
    }
</script>
```

## radio单选框组实现

```html
<template>
    <el-radio-group v-model="radio">
        <el-radio :label="3">备选项</el-radio>
        <el-radio :label="6">备选项</el-radio>
        <el-radio :label="9">备选项</el-radio>
    </el-radio-group>
</template>
```

在这个功能中，我们注意到，`v-model`的位置从`el-radio`中移动到了`el-radio-group`中、

那么我们就一定需要做到两点：
* 为了显示，要把v-model/value的值从el-radio-group中转发到el-radio中（向下）
* 为了修改，要让input事件在el-radio-group中触发，并带上label值（向上）

源码是是如何实现的呢？

既然`v-model`的位置已经向上移动了一层，我们也必须向上找一层

**向下:point_down:**

现在model的来源不应该只是自己了：

```js
computed:{
    isGroup() {
        let parent = this.$parent;
        while (parent) {
            if (parent.$options.componentName !== 'ElRadioGroup') {
                parent = parent.$parent;
            } else {
                this._radioGroup = parent;  //向上找到el-radioGroup节点
                return true;
            }
        }
        return false;
    },
    model: {
        get() {
            //如果有el-radio-group包裹，则使用的是el-radio-group的value
            return this.isGroup ? this._radioGroup.value : this.value;
        },
        set(val) {
            if (this.isGroup) {  //如果有el-radio-group包裹，不应该自己emit发送事件
                this.dispatch('ElRadioGroup', 'input', [val]);
            } else {
                this.$emit('input', val);
            }
        }
    }
}
```

**:point_up:向上（dispatch）**

**dispatch**用于在el-radio中让el-radio-group触发方法

:::info
考虑到复用性，dispath方法实际来源于mixins混入
:::

```js title="dispatch方法"
dispatch(componentName, eventName, params) {
    var parent = this.$parent || this.$root;
    var name = parent.$options.componentName;

    while (parent && (!name || name !== componentName)) { //找到el-radio-group组件
        parent = parent.$parent;

        if (parent) {
            name = parent.$options.componentName;
        }
    }
    if (parent) {
        //让el-radio-group触发事件
        parent.$emit.apply(parent, [eventName].concat(params));
    }
},
```

其中有一条语句较为复杂：
```js
parent.$emit.apply(parent, [eventName].concat(params));
```
其中，`eventName`的值是`'input'`

`params`的值是`label`的值带上数组，假设为`[3]`

```js
[eventName].concat(params) //=> [input,3]
```
:::tip
Array.prototype.concat会打平一层数组
:::

所以实际上在parent中将会触发如下的等价形式的语句：
```
this.$emit('input',3)
```

## 按钮样式

el-radio-button相比于el-radio仅仅多了些样式，并没有核心功能的改变

在官方文档试着删除有关el-radio-button样式的时候，实际上表现出来的形式和el-radio相差不多：

<Image path="https://img-blog.csdnimg.cn/bde8aef2563c404aa2d970813b5a688a.png"/>

## KeyCode

其实用键盘(**←↓↑→**)也可以切换按钮，但官方文档其实没有说明，效果如下：

<Image path="https://img-blog.csdnimg.cn/498a9dd9d2294bf5b273963010f651a1.gif"/>

如何实现的？

```html title="radio-group部分源码"
<template>
    <component
        :is="_elTag"
        @keydown="handleKeydown"
    >
        <slot></slot>
    </component>
</template>
```

触发`handleKeydown`事件：

✔**在查看handleKeydown具体实现时，你需要预先了的一些事情：**

:one:按钮样式组和非按钮样式组都能触发键盘事件，但是必须先用鼠标点击触发焦点：

<Image path="https://img-blog.csdnimg.cn/dd58b0ef34b74826b0140ef9373e304b.gif"/>

:two: 按键触发的event.target不一定是input

:three: el-radio和el-radio-group都有如下结构：

```html
<label role="radio">
    <input type="radio"/>
</label>
```

**handleKeydown结构**

```js
handleKeydown(e) { // 左右上下按键 可以在radio组内切换不同选项
    const target = e.target; 
    const className = target.nodeName === 'INPUT' ? '[type=radio]' : '[role=radio]';
    const radios = this.$el.querySelectorAll(className);
    const length = radios.length;
    const index = [].indexOf.call(radios, target); //获取当前元素下标
    const roleRadios = this.$el.querySelectorAll('[role=radio]');  //获取所有子节点
    switch (e.keyCode) {  //根据输入的keyCode决定哪个组件高亮
        case keyCode.LEFT:
        case keyCode.UP:
            e.stopPropagation();
            e.preventDefault();
            if (index === 0) {
                roleRadios[length - 1].click();
                roleRadios[length - 1].focus();
            } else {
                roleRadios[index - 1].click();
                roleRadios[index - 1].focus();
            }
            break;
        case keyCode.RIGHT:
        case keyCode.DOWN:
            if (index === (length - 1)) {
                e.stopPropagation();
                e.preventDefault();
                roleRadios[0].click();
                roleRadios[0].focus();
            } else {
                roleRadios[index + 1].click();
                roleRadios[index + 1].focus();
            }
            break;
        default:
            break;
    }
}
```










